<!doctype html>
<html lang="en">
<head>
    <title>Code coverage report for universal/gpii/node_modules/canopyMatchMaker/src/CanopyMatchMakerUtilities.js</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="../../../../../prettify.css" />
    <link rel="stylesheet" href="../../../../../base.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style type='text/css'>
        .coverage-summary .sorter {
            background-image: url(../../../../../sort-arrow-sprite.png);
        }
    </style>
</head>
<body>
<div class='wrapper'>
  <div class='pad1'>
    <h1>
      <a href="../../../../../index.html">All files</a> / <a href="index.html">universal/gpii/node_modules/canopyMatchMaker/src</a> CanopyMatchMakerUtilities.js
    </h1>
    <div class='clearfix'>
      <div class='fl pad1y space-right2'>
        <span class="strong">100% </span>
        <span class="quiet">Statements</span>
        <span class='fraction'>80/80</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">100% </span>
        <span class="quiet">Branches</span>
        <span class='fraction'>30/30</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">100% </span>
        <span class="quiet">Functions</span>
        <span class='fraction'>13/13</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">100% </span>
        <span class="quiet">Lines</span>
        <span class='fraction'>77/77</span>
      </div>
    </div>
  </div>
  <div class='status-line high'></div>
<pre><table class="coverage">
<tr><td class="line-count quiet">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164</td><td class="line-coverage quiet"><span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3x</span>
<span class="cline-any cline-yes">3x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3x</span>
<span class="cline-any cline-yes">632x</span>
<span class="cline-any cline-yes">632x</span>
<span class="cline-any cline-yes">6956x</span>
<span class="cline-any cline-yes">6956x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">632x</span>
<span class="cline-any cline-yes">632x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3x</span>
<span class="cline-any cline-yes">764x</span>
<span class="cline-any cline-yes">764x</span>
<span class="cline-any cline-yes">1794x</span>
<span class="cline-any cline-yes">1794x</span>
<span class="cline-any cline-yes">216x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1578x</span>
<span class="cline-any cline-yes">1578x</span>
<span class="cline-any cline-yes">548x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3x</span>
<span class="cline-any cline-yes">167x</span>
<span class="cline-any cline-yes">167x</span>
<span class="cline-any cline-yes">640x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">167x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3x</span>
<span class="cline-any cline-yes">165x</span>
<span class="cline-any cline-yes">630x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">165x</span>
<span class="cline-any cline-yes">165x</span>
<span class="cline-any cline-yes">630x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3x</span>
<span class="cline-any cline-yes">163x</span>
<span class="cline-any cline-yes">163x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">163x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">163x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">163x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">163x</span>
<span class="cline-any cline-yes">163x</span>
<span class="cline-any cline-yes">626x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">163x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">165x</span>
<span class="cline-any cline-yes">1515x</span>
<span class="cline-any cline-yes">1515x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">165x</span>
<span class="cline-any cline-yes">630x</span>
<span class="cline-any cline-yes">630x</span>
<span class="cline-any cline-yes">12x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">618x</span>
<span class="cline-any cline-yes">618x</span>
<span class="cline-any cline-yes">6867x</span>
<span class="cline-any cline-yes">6867x</span>
<span class="cline-any cline-yes">1440x</span>
<span class="cline-any cline-yes">1440x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">618x</span>
<span class="cline-any cline-yes">237x</span>
<span class="cline-any cline-yes">237x</span>
<span class="cline-any cline-yes">237x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">381x</span>
<span class="cline-any cline-yes">381x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">165x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3x</span>
<span class="cline-any cline-yes">6695x</span>
<span class="cline-any cline-yes">6695x</span>
<span class="cline-any cline-yes">15655x</span>
<span class="cline-any cline-yes">15655x</span>
<span class="cline-any cline-yes">15655x</span>
<span class="cline-any cline-yes">5103x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1592x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3x</span>
<span class="cline-any cline-yes">13773x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">13773x</span>
<span class="cline-any cline-yes">7136x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">6637x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3x</span>
<span class="cline-any cline-yes">10555x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span></td><td class="text"><pre class="prettyprint lang-js">/*!
GPII Canopy Matchmaker
&nbsp;
Copyright 2012 OCAD University
Copyright 2012 Antranig Basman
&nbsp;
Licensed under the New BSD license. You may not use this file except in
compliance with this License.
&nbsp;
The research leading to these results has received funding from the European Union's
Seventh Framework Programme (FP7/2007-2013) under grant agreement no. 289016.
&nbsp;
You may obtain a copy of the License at
https://github.com/GPII/universal/blob/master/LICENSE.txt
*/
&nbsp;
"use strict";
&nbsp;
var fluid = fluid || require("infusion");
var gpii = gpii || fluid.registerNamespace("gpii");
&nbsp;
fluid.registerNamespace("gpii.canopyMatchMaker.utils");
&nbsp;
gpii.canopyMatchMaker.utils.computeFitness = function (leaves, solution, ontologicalMetricFunction) {
    var vector = [];
    for (var i = 0; i &lt; leaves.length; ++i) {
        var leaf = leaves[i];
        vector[i] = ontologicalMetricFunction(leaf, solution);
    }
    vector = vector.sort(gpii.canopyMatchMaker.utils.sortDescending);
    return vector;
};
&nbsp;
gpii.canopyMatchMaker.utils.compareFitness = function (solA, solB) {
    var i = 0, fitA = solA.fitness, fitB = solB.fitness;
    for (; ; ++i) {
        var endA = i === fitA.length, endB = i === fitB.length;
        if (endA || endB) {
            return endA &amp;&amp; endB ? 0 : (endB ? -1 : 1);
        }
        var diff = fitB[i] - fitA[i];
        if (diff !== 0) {
            return diff;
        }
    }
};
&nbsp;
/*
 * @leaves {object}
 * @solrecs {object} map of solutions keyed by solution id.
 */
gpii.canopyMatchMaker.utils.sortSolutions = function (solutions) {
    var solArr = [];
    for (var i in solutions) {
        solArr.push(solutions[i]);
    }
    return solArr.sort(gpii.canopyMatchMaker.utils.compareFitness);
};
&nbsp;
/*
 * @leaves {object}
 * @solrecs {object} map of solutions keyed by solution id.
 */
gpii.canopyMatchMaker.utils.rankSolutions = function (leaves, solrecs, ontologicalMetricFunction) {
    fluid.each(solrecs, function (solrec) {
        solrec.fitness = gpii.canopyMatchMaker.utils.computeFitness(leaves, solrec.skeleton, ontologicalMetricFunction);
    });
    var solArr = gpii.canopyMatchMaker.utils.sortSolutions(solrecs);
    return fluid.transform(solArr, function (value) {
        return value.index;
    });
};
&nbsp;
/*
 * @leaves {object}
 * @solrecs {object} map of solutions keyed by solution id.
 */
gpii.canopyMatchMaker.utils.disposeStrategy = function (leaves, solrecs, data, ontologyMetadata) {
    var ontologicalMetricName = fluid.get(ontologyMetadata, "ontologicalMetricFunction") || "gpii.canopyMatchMaker.utils.prefixLength";
    var ontologicalMetricFunction = fluid.getGlobalValue(ontologicalMetricName);
    // if we already have priority for some solutions, accept these and reject any applications
    // of same type.
    gpii.matchMakerFramework.utils.disposeFromPriority(solrecs, data);
    // rank remaining solutions based on fit to preferences
    var ranked = gpii.canopyMatchMaker.utils.rankSolutions(leaves, solrecs, ontologicalMetricFunction);
    // dispose based on canopy
    var disposed = gpii.canopyMatchMaker.utils.disposeFromCanopy(leaves, ranked, solrecs, data, ontologicalMetricFunction);
    // re-key by solution id:
    var togo = {};
    fluid.each(disposed, function (val) {
        togo[val.index] = val;
    });
    return togo;
};
&nbsp;
gpii.canopyMatchMaker.utils.disposeFromCanopy = function (leaves, ranked, solrecs, data, ontologicalMetricFunction) {
    // Set default canopy to negative leaf depth. To raise the canopy, a preference needs to
    // match at least one level into the leaf.
    var canopy = fluid.transform(leaves, function (leaf) {
        var leafDepth = fluid.pathUtil.parseEL(leaf).length;
        return -leafDepth;
    });
&nbsp;
    for (var i = 0; i &lt; ranked.length; ++i) {
        var sol = solrecs[ranked[i]];
        if (sol.disposition === "reject") {
            continue;
        }
&nbsp;
        var inCanopy = false;
        for (var j = 0; j &lt; leaves.length; ++j) {
            var depth = ontologicalMetricFunction(leaves[j], sol.skeleton);
            if (depth &gt; canopy[j]) {
                inCanopy = true;
                canopy[j] = depth;
            }
        }
        if (inCanopy) {
            sol.disposition = "accept";
            sol.dispositionReason = "Was the solution of this type that best fit user preferences";
            gpii.matchMakerFramework.utils.rejectFromTypes(data.solutionTypes[sol.index],
                data.solutionTypeMapping, solrecs, "Another solution (" + sol.index +
                ") covering more preferences was found found.");
        } else {
            sol.disposition = "reject";
            sol.dispositionReason = "Was not in canopy.";
        }
    }
    return solrecs;
};
&nbsp;
/** Returns a non-positive number indicating by how many path segments the supplied
 * path fails to index correctly into the supplied model. A return value of 0
 * indicates that the path indexes fully
 */
gpii.canopyMatchMaker.utils.prefixLength = function (path, model) {
    var segs = fluid.pathUtil.parseEL(path);
    for (var i = 0; i &lt; segs.length; ++i) {
        var seg = segs[i];
        model = model[seg];
        if (model === undefined) {
            return i - segs.length;
        }
    }
    return 0;
};
&nbsp;
fluid.registerNamespace("gpii.canopyMatchMaker.utils.ISO24751");
&nbsp;
gpii.canopyMatchMaker.utils.ISO24751.ontologicalMetric = function (path, model) {
    var segs = fluid.pathUtil.parseEL(path);
    // if it's an application setting and the application is not matching, consider worst fit
    if (segs[0] === "applications" &amp;&amp; fluid.get(model, ["applications", segs[1]]) === undefined) {
        return -Infinity;
    } else { // else do fitting as usual
        return gpii.canopyMatchMaker.utils.prefixLength(path, model);
    }
};
&nbsp;
// only used by canopyMatchMaker - moved from MatchMakerFramework
gpii.canopyMatchMaker.utils.sortDescending = function (numA, numB) {
    return numB - numA;
};
&nbsp;</pre></td></tr>
</table></pre>
<div class='push'></div><!-- for sticky footer -->
</div><!-- /wrapper -->
<div class='footer quiet pad2 space-top1 center small'>
  Code coverage
  generated by <a href="https://istanbul.js.org/" target="_blank">istanbul</a> at Thu Feb 15 2018 17:10:07 GMT+0100 (CET)
</div>
</div>
<script src="../../../../../prettify.js"></script>
<script>
window.onload = function () {
        if (typeof prettyPrint === 'function') {
            prettyPrint();
        }
};
</script>
<script src="../../../../../sorter.js"></script>
</body>
</html>
